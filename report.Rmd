---
title: "Growing shade report"
date: "`r format(Sys.time(), '%d %B %Y')`"

params:
  selected_tract: NA
  selected_geo: NA
  selected_city: NA
  vars_used: NA
  priority_score: NA
  rank_total: NA
  vars_selected: NA
urlcolor: blue
---

```{r assignments, echo=F, message=F, warning=F, results='hide'}
library(tidyverse)
library(leaflet)
library(mapview)

# knitr::opts_chunk$set(echo = FALSE, message = F, warning = F, tidy.opts=list(width.cutoff=50))
         
# output: 
#   html_document:
#     toc: true
#     toc_depth: 3
#     # css: "inst/app/www/style.css"

# code_folding: show

params$selected_tract
params$selected_geo
params$selected_city
params$vars_used
params$priority_score #scaled and centered average based on inputs
params$priority_rank #rank of scaled and centered average based on inputs
# rank_total #number of tracts total

reportfor <- if (params$selected_geo == "City (MetCouncil region only)") {
  params$selected_city
} else if (params$selected_geo == "Selected tract") {
  paste0("tract ", params$selected_tract)
} else if (params$selected_geo == "County (within MN or WI)") {
  'PRANK! nothing to see here yet'
}

scaled_summed <- params$priority_score %>%
  filter(tract_string == params$selected_tract)

fheight = if (nrow(params$vars_selected) < 3) {
  3
} else {nrow(params$vars_selected)}

eabcount<- eab %>%
  sf::st_intersection(filter(mn_tracts, #crop_tract_ctus, 
                      GEOID == params$selected_tract)) %>% nrow()


```



# Report for `r reportfor`

This report was generated from the Growing Shade interactive tool produced by the Metropolitan Council in collaboration with The Nature Conservancy and Tree Trust. Trees provide critical ecosystem services and are important components of the human, natural and built environments. Enhancing and maintaining tree canopy cover is an actionable step to create healthy places for people to live and a resilient future.

This report synthesizes and summarizes data about trees, people, and the built environments. Understanding the tree canopy within this larger context is important for prioritization and planning efforts. Please review "what's next for Growing Shade" or contact us at SOME EMAIL HERE if this report does not address your data needs - we welcome the feedback and may be able to accommodate requests.

## Status of the tree canopy

This section summarizes the how the tree canopy priority of the selected region compares to other geographies across the region.

 ```r reportfor``` has an existing tree coverage of approximately ```r ```%. 

If you wish to obtain a map of the area, please use the interactive tool - just zoom in as desired and take a screenshot (<a href = 'https://support.microsoft.com/en-us/windows/how-to-take-and-annotate-screenshots-on-windows-10-ca08e124-cc30-2579-3e55-6db63e36fbb9' target = '_blank'>instructions for Windows</a> or <a href = 'https://support.apple.com/en-us/HT201361' target = '_blank'>instructions for Mac</a>). We recommend turning off the "priority scores" layer when doing so. 

```{r map, echo = F, message = F, warning = F, fig.height=5, fig.width=8}
# We have chosen not to print an overview map in this space, because the time needed to generate the map adds considerably to the processing time of this report. Please note higher resolution images (and images with different underlying basemaps) can be obtained from the interactive tool - just zoom in to the desired level and take a screenshot. We recommend turning off the priority scores and using the "aerial imagery with roads" basemap. 

# map_path <- paste0(tempdir(), "/map.png")
# 
# mapshot(
#   leaflet() %>%
#       addMapPane(name = "Aerial Imagery", zIndex = 100) %>%
#       addMapPane(name = "Aerial Imagery with roads", zIndex = 100) %>%
#       addMapPane(name = "Road outlines", zIndex = 151) %>%
#       addProviderTiles("Stamen.TonerLines", 
#                        options = pathOptions(pane = "Road outlines"),
#                        group = "Aerial Imagery with roads") %>%
#       addProviderTiles("Stamen.TonerLabels",
#                        options = c(zIndex = 600),# pathOptions(pane = "Stamen Toner"),
#                        group = "Aerial Imagery with roads") %>%
#       addProviderTiles(
#         provider = providers$Esri.WorldImagery,
#         group = "Aerial Imagery with roads",
#         options = pathOptions(pane = "Aerial Imagery")
#       ) %>%
#   addRasterImage(trees %>%
#   raster::crop(filter(mn_tracts,#crop_tract_ctus, 
#                       # GEOID == "27053109100")),
#                       GEOID == params$selected_tract)),
#                  colors = "#238b45", #pal,
#                                   opacity = .8,
#                                   layerId = "Trees",
#                                   group = "Trees"#,
#                                   # project = FALSE)
#                    ) %>%
#     addPolygons(data = filter(mn_tracts,
#                               GEOID == params$selected_tract),
#                               # GEOID == "27053109100"),
#                 fill = NA,
#                 opacity = 1,
#                 color = councilR::colors$councilBlue) %>%
#   addLayersControl(
#         position = "bottomright",
#         baseGroups = c(
#           "Aerial Imagery with roads"
#         ),
#         overlayGroups = c(
#           "Trees"),
#         options = layersControlOptions(collapsed = T)
#       ),
#   file = map_path, cliprect = "viewport")
# 
# knitr::include_graphics(map_path)
```

## Priortization summary

Based on the ```r params$vars_used``` preset used, the selected area ranks ```r scaled_summed$RANK``` out of ```r params$rank_total``` with an average priority score of ```r round(scaled_summed$MEAN, 3)``` (out of 10, with 10 indicating the highest priority).

The specific variables which went into this ranking include : 
```{r, echo=F, message=F, warning=F}
row_count <-  nrow(params$vars_selected)
        if(!is.null(row_count)){
            # write a function to create a list from the vector
            vectorBulletList <- function(vector) {
                if(length(vector > 1)) {
                    paste0("<ul><li>", 
                           paste0(
                               paste0(vector, collpase = ""), collapse = "</li><li>"),
                           "</li></ul>")   
                }
            }
        }
HTML(paste0("<code>",vectorBulletList(params$vars_selected$value), "</code>"))
```

Here is how the selected area compares to the regional average **for the selected variables**. The plot shows the scaled and standardized scores on the x-axis. The table shows the raw values. Please refer to the Methods tab for more detail.

Please go the the Appendix at the bottom of the report for more information on all the variables. 

```{r status, echo=F, message=F, warning=F, fig.height=fheight, fig.width=7}
testdf <- eva_data_main %>%
  full_join(metadata)#%>% filter(variable == "prim_flood")
testtr <- params$selected_tract


summary_table <- filter(testdf, tract_string == testtr) %>%
  mutate(overall_rank = as.factor(overall_rank)) %>%
   mutate(across(c(raw_value, MEANRAW), ~ifelse(str_detect(name, "%"), . * 100, .))) %>%
  mutate(across(where(is.numeric), round, 2))
# 
# 
# # if (params$vars_used == "Custom"){
summary_table %>%
ungroup() %>%
select(name, MEANSCALED, weights_scaled) %>%
filter(name %in% params$vars_selected$value) %>%
  pivot_longer(names_to = "TYPE", values_to = "VALUES", -name) %>%
  mutate(TYPE = case_when(TYPE == "MEANSCALED" ~ "Regional average",
                          TYPE == "weights_scaled" ~ "Selected area")) %>%
  ggplot(aes(y = name, x=  VALUES, fill= TYPE)) +
  geom_bar(stat = "identity", position = position_dodge(width = .5), width = .5, size = .75) +
  # facet_grid(PRESETVAR ~., space = "free_y", scales = "free_y") +
  councilR::council_theme() +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))+
  scale_fill_manual(values = c(councilR::colors$councilBlue, councilR::colors$cdGreen),
                    name = "Geography") +
  # scale_color_manual(values = c(councilR::colors$mtsRed, "white")) +
  labs(y = "", x = "Score (out of 10)") +
  theme(panel.border = element_rect(colour = "black", fill = NA),
        # axis.text.y = element_text(size = 12),
        # axis.title.x = element_text(size = 12)
        strip.text = element_text(size = 12),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom")
#   
#   
# # }
# 


```





```{r table, echo = F, mesasge = F, warning = F}

knitr::kable(summary_table %>%
               ungroup() %>%
               select(name, raw_value, MEANRAW, overall_rank, n) %>%
               filter(name %in% params$vars_selected$value) %>%
               rename(Variable = name,
                      `Selected area` = raw_value,
                      `Regional average` = MEANRAW,
                      `Ranking (1 = highest priority)` = overall_rank,
                      `Total ranked areas` = n), "simple")

```


## Equity analysis

The goal of this section is to show how people and trees interact, and where the selected geography compares. 

Research shows that trees are unevenly distributed across communities. In particular, neighborhoods with high BIPOC populations or low-income have less tree canopy (<a href = 'https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0249715' target = '_blank'>MacDonald 2021</a>) as do areas which were historically redlined (<a href = 'https://www.npr.org/2020/01/14/795961381/racist-housing-practices-from-the-1930s-linked-to-hotter-neighborhoods-today' target = '_blank'>NPR news story</a>, scientific articles: <a href = 'https://www.nature.com/articles/s42949-021-00022-0' target = '_blank'>Locke et al. 2021</a>, media coverage by <a href = 'https://www.sciencedirect.com/science/article/abs/pii/S0277953619307531?via%3Dihub' target = '_blank'>Namin et al. 2020</a>) ).  Addressing inequity in tree canopy cover may reduce heat-related deaths by up to 25% a href = 'https://www.fs.fed.us/nrs/pubs/jrnl/2021/nrs_2021_paramita_001.pdf' target = '_blank'>Sinha 2021</a>).

At the MetCouncil, we have shown that areas where the median income is <100,000 and areas with high BIPOC populations have less tree canopy and greenness. We are specifically calling out these variables in figures here. 


```{r equityfig, echo=F, message = F, warning = F}
ggplot(mtcars, aes(x = cyl, y = mpg)) +
  geom_point()

```

## Trees past and present (with lessons for the future)

The goal of this section is present information about other considerations. 

Threats include low biodiversity:

Emerald Ash Borer DNR Map shows that there are ```r eabcount``` trees infected with EAB. This is likely incomplete and out of date. 

Something about tree community composition. 

Biodiversity, native/non-native. Before probably a lot of biodiversity, now not so much. 

# What's next for Growing Shade?

This tool is under active development (probably). Can we have people sign up for an email list to be notified when more features are added? Underlying land use in map (talk to gis folks), tree canopy uploaded to mn geospatial commons, tree biodiversity data on map (if it exists in decent coverage), expanding to greater MN/WI/MI, updating to 2021 tree canopy (or other years), maybe including some canopy loss/gain metrics over time (5 year time span, or something), news or use cases highlighted?, drilling down to block groups (when equity considerations are updated), tree short course talk coming up, base data updated for most recent years (equity considerations data), if we add something on "tree stress" (variability in ndvi over time?)

# Other resources

The Growing Shade is a unique tool offering users the ability to customize prioritization and see detailed maps of tree canopy gaps. However, there are other tools users may be additionally interested in. Find this list in the resources 

- This tool; link here
  - use it for x y z
- another tool that is cool
  - and why 
- you might want to do this instead
  - and you can do this
  
  
# Appendix


Because we believe that context is important, this is how the selected area compares to the regional average for all the presets available in the Growing Shade application. Do note that some variables are shared across presets. 

```{r echo = F, message=F, warning = F, fig.height=8, fig.width=7}
# If the variable was used in the user-selected ranking, those bars are outlined in red. 

forplot <- summary_table %>%
  ungroup() %>%
  select(name, MEANSCALED, weights_scaled, ej, cc, ph, cons) %>%
  pivot_longer(names_to = "TYPE", values_to = "VALUES", -c(name, ej, cc, ph, cons)) %>%
  pivot_longer(names_to = "PRESETVAR", values_to = "PRESETVAL", -c(name, TYPE, VALUES)) %>%
  filter(PRESETVAL == 1) %>%
  mutate(PRESETVAR = case_when(PRESETVAR == "ej" ~ "Environmental justice",
                               PRESETVAR == "cc" ~ "Climate change",
                               PRESETVAR == "ph" ~ "Public health",
                               PRESETVAR == "cons" ~ "Con-\nserv-\nation"),
         TYPE = case_when(TYPE == "MEANSCALED" ~ "Regional average",
                          TYPE == "weights_scaled" ~ "Selected area"))
         

forplot %>%
  # mutate(FLAG = case_when(name %in% params$vars_selected$value ~ "flag",
  #                         TRUE ~ NA_character_)) %>%
  ggplot(aes(y = name, x=  VALUES, fill= TYPE))+#, col = FLAG)) + 
  geom_bar(stat = "identity", position = position_dodge(width = .5), width = .5, size = .75) +
  # coord_flip() +
  facet_grid(PRESETVAR ~., space = "free_y", scales = "free_y") +
  councilR::council_theme() +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 50))+
  scale_fill_manual(values = c(councilR::colors$councilBlue, councilR::colors$cdGreen),
                    name = "Geography") +
  # scale_color_manual(values = c(councilR::colors$mtsRed, "white")) +
  labs(y = "", x = "Weighted value (out of 10)") +
  theme(panel.border = element_rect(colour = "black", fill = NA),
        # axis.text.y = element_text(size = 12),
        # axis.title.x = element_text(size = 12)
        strip.text = element_text(size = 12),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom")#  +
  # guides(color = F)
  
```


```{r tableall, echo = F, mesasge = F, warning = F}

knitr::kable(summary_table %>%
               ungroup() %>%
               select(name, raw_value, MEANRAW, overall_rank, n) %>%
               # filter(name %in% params$vars_selected$value) %>%
               rename(Variable = name,
                      `Selected area` = raw_value,
                      `Regional average` = MEANRAW,
                      `Ranking (higher rank = higher priority)` = overall_rank,
                      `Total ranked areas` = n), "simple")

```

